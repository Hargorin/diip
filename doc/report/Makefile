# LaTeX Makefile

PROJECT=main
OUTPUT=p6_diip_huetter_stocker
BIBER=biber
PDFLATEX=pdflatex -file-line-error -interaction=nonstopmode -output-directory . -jobname $(OUTPUT) $(PROJECT)
BIBTEX=bibtex
GLOSSARY=makeglossaries p6_diip_huetter_stocker
PDFVIEWER = evince

CHAPTERS_DIR=chapters
OUT_DIR=build

# For tikz
TNAME=images/image_processing/wallis_vhdl.tikz

SRC_FILES := $(wildcard $(CHAPTERS_DIR)/*.tex)
PDF_FILES := $(patsubst $(CHAPTERS_DIR)/%.tex,$(OUT_DIR)/%.pdf,$(SRC_FILES))
UNAME := $(shell uname)

# $(call convert_to_png, input.pdf, output,png)
define convert_to_png_lnx
	convert -density 150 $(1) -quality 90 $(2)
endef
define convert_to_png_mac
	sips -s format png --out $(2) $(1)
endef

all: $(OUTPUT).pdf

$(OUTPUT).pdf : *.tex chapters/*.tex revision
	$(PDFLATEX)
	# $(BIBTEX) $(OUTPUT)
	$(BIBER) $(OUTPUT).bcf
	$(GLOSSARY)
	$(PDFLATEX)
	$(PDFLATEX)

open: $(OUTPUT).pdf
	(${PDFVIEWER} $(OUTPUT).pdf &)

revision:
	mkdir -p build
	echo "% Autogenerated, do not edit" > build/revision.tex
	echo "\\\newcommand{\\\revisiondate}{`git log -1 --format=\"%ad\" --date=iso`}" >> build/revision.tex
	echo "\\\newcommand{\\\revision}{`git log -1 --format=\"%H\"`}" >> build/revision.tex
	echo "\\\newcommand{\\\compiledate}{`date`}" >> build/revision.tex
	echo "\\\newcommand{\\\hostname}{`hostname`}" >> build/revision.tex

tikz:
	mkdir -p build
	pdflatex -file-line-error -interaction=nonstopmode -output-directory build/ -jobname=$(patsubst %.tikz,%,$(notdir $(TNAME))) "\input{tikzpre}\input{$(TNAME)}\input{tikzpost}"
ifeq ($(UNAME),Darwin)
	$(call convert_to_png_mac, build/$(patsubst %.tikz,%.pdf,$(notdir $(TNAME))) , build/$(patsubst %.tikz,%.png,$(notdir $(TNAME))))
endif
ifeq ($(UNAME),Linux)
	$(call convert_to_png_lnx, build/$(patsubst %.tikz,%.pdf,$(notdir $(TNAME))) , build/$(patsubst %.tikz,%.png,$(notdir $(TNAME))))
endif

cleanall: clean
	rm -f *.dvi *.log *.bak *.aux *.bbl *.blg *.idx *.ps *.eps *.pdf *.toc *.out *.fdb_latexmk *.fls *~ build/*

clean:
	rm -f *.log *.bak *.aux *.bbl *.blg *.idx *.toc *.out *~ build/* *.glg *.glo *.gls *.ist *.lof *.lot 

.PHONY: all pdf clean cleanall chunks open tikz


